<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns:tls="http://www.mulesoft.org/schema/mule/tls" xmlns:api-gateway="http://www.mulesoft.org/schema/mule/api-gateway"
	xmlns:secure-properties="http://www.mulesoft.org/schema/mule/secure-properties"
	xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/secure-properties http://www.mulesoft.org/schema/mule/secure-properties/current/mule-secure-properties.xsd
http://www.mulesoft.org/schema/mule/api-gateway http://www.mulesoft.org/schema/mule/api-gateway/current/mule-api-gateway.xsd
http://www.mulesoft.org/schema/mule/tls http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd">
	<sub-flow name="smb-ux-busines-deposit-flow" doc:id="ff5eaa5e-9793-4e00-bd08-25889109cf70" >
		<logger level="INFO" doc:name="Logger" doc:id="27062994-1299-4fb7-a5be-ec297e191c04" />
		<flow-ref doc:name="smb-ux-salesforce-objects-query-subflow" doc:id="4094aea6-e1c5-4adf-bd8d-08e60b366fe3" name="smb-ux-salesforce-objects-query-subflow"/>
		<ee:transform doc:name="Transform Message" doc:id="7f0a8dbb-9eb2-4c3e-bc52-53cb3946ecfb" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="VSPAplicant" ><![CDATA[%dw 2.0
output application/json
import * from dw::core::Strings

var modelCode =
  if (vars.ApplicantInfo.customerType=="2" and vars.ApplicantInfo.product=="T")  
    "TreasuryCams" 
  else if (vars.ApplicantInfo.customerType=="2" and vars.ApplicantInfo.product=="D") 
    "smbBusiness"
  else if (vars.ApplicantInfo.customerType=="2" and vars.ApplicantInfo.product=="L" ) 
     "smbCredit1"
  else 
    "smbSigner"

---
{
	"RequestDate": now(),
    "RequestID":vars.ApplicantInfo.applicationId,
    "PersonID": vars.sfAppPayload.Name_of_Business__c[0],
    "IP": vars.sfAppPayload.applicant_ip[0] default "",
    "useBlacklist": false,
    "Model": modelCode,
    "ClientID": "1",
    "Company": {
      "CompanyName": vars.sfAppPayload.Name_of_Business__c[0],
      "AlternateCompanyName": vars.sfAppPayload.Altrnate_Business_Name__c[0],
      "FEIN": vars.sfAppPayload.EIN__c[0],
      "Phone": vars.sfAppPayload.Business_Phone__c[0],
      "StreetAddress1": vars.sfAppPayload.Business_Address_1__c[0],
      "StreetAddress2": vars.sfAppPayload.Business_Address_2__c[0],
      "City": vars.sfAppPayload.Business_City__c[0],
      "State": vars.sfAppPayload.Business_State__c[0],
      "Zip": vars.sfAppPayload.Business_Zip__c[0],
  
      "ApplicantSigners": [
        {
         "FirstName": vars.sfAppPayload.First_Name__c[0],
        "LastName": vars.sfAppPayload.Last_Name__c[0],
        "StreetAddress1": vars.sfAppPayload.Address_1__c[0],
        "StreetAddress2": vars.sfAppPayload.Address_2__c[0],
        "City": vars.sfAppPayload.City__c[0],
        "State": vars.sfAppPayload.State__c[0],
        "Zip": vars.sfAppPayload.Zip__c[0],
        "Phone": vars.sfAppPayload.Phone__c[0],
        "Email": vars.sfAppPayload.Email__c[0],
        "SSN": vars.sfAppPayload.Social_Security_Number__c[0],
        "DOB": vars.sfAppPayload.Birth_Date__c[0],
        "IDType":  if(vars.sfAppPayload.ID_Type__c[0]== "Driver's License") 1 else 9,
        "IDState": vars.sfAppPayload.ID_State__c[0],
        "IDCountry": vars.sfAppPayload.ID_Country__c[0] default "",
        "IDNumber": vars.sfAppPayload.ID_Number__c[0]
        }
      ]
    }
  }
]]></ee:set-variable>
			</ee:variables>
		
</ee:transform>
		<flow-ref doc:name="SMB-UX-VSP-loginFlow" doc:id="1858091e-46f7-4656-9e5f-fa7679ce77c1" name="SMB-UX-VSP-loginFlow" target="Authorization"/>
		<set-variable value="#[vars.Authorization]" doc:name="Copy_of_Set Variable" doc:id="c4047cc0-2a3d-4296-a09c-6868bb698538" variableName="BearerToken" />
		<http:request method="POST" doc:name="Request" doc:id="c8f6b22d-e273-41e3-88b3-cf8fc026e29b" path="/score" config-ref="HTTP_Request_VSP_configuration">
			<http:body ><![CDATA[#[vars.VSPAplicant]]]></http:body>
			<http:headers ><![CDATA[#[{
	"Authorization" : "Bearer " ++ vars.BearerToken
}]]]></http:headers>
		</http:request>
		<ee:transform doc:name="Copy_of_Transform Message" doc:id="923d2abf-b1e3-4e70-bde3-39be34280586">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="RejectedDecisions"><![CDATA[%dw 2.0
output application/json
---
if(payload.decisions.code[0]=="ejected")true else false]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<choice doc:name="Choice" doc:id="13542e21-8c2d-4dab-95c9-88976ed8197e" >
			<when expression="#[vars.RejectedDecisions == true]">
				<logger level="INFO" doc:name="Logger" doc:id="57f08c49-4024-4779-b9b9-51de7637fec5" />
				<flow-ref doc:name="smb-ux-business-debit-sub-flow" doc:id="50a13a31-0ddd-4deb-bf76-8ed59cd97d75" name="smb-ux-business-debit-sub-flow" target="upsertData"/>
			
</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="a8e8eeb9-0e6b-45e0-a5fd-e28ddb2b49d7" />
				<flow-ref doc:name="smb-ux-business-debit-sub-flow" doc:id="cd223a22-411d-4d15-8b3a-6429f7c5a01f" name="smb-ux-business-debit-sub-flow" target="upsertData"/>
				<flow-ref doc:name="smb-ux-additional-appliacant-flow" doc:id="99683e20-eda9-404a-ad50-b71d2c75ce1d" name="smb-ux-additional-appliacant-flow"/>
			

</otherwise>
		</choice>
		<ee:transform doc:name="Transform Message" doc:id="3548c5c6-f291-47d4-b9ae-686bcf794cd0" >
			<ee:message >
				<ee:set-payload ><![CDATA[ {"score_result": { 
 "applicationId": if(payload.items.payload.id[0]== true) payload.items.payload.id[0] else vars.ApplicantInfo.applicationId, 
 "customerType": vars.ApplicantInfo.customerType,
 "product": vars.ApplicantInfo.product,
 "VSPStatus":if (vars.outPayload.VSP_Status_Primary_Applicant__c[0]== true) vars.outPayload.VSP_Status_Primary_Applicant__c[0] else vars.outPayload.VSP_Status_Business__c[0]
 },
 "metadata":{
 	status: 200,
 	message: if (payload.items.payload.success[0]== true) "Success" else payload.statusCode[0] 
 }
 
 }]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	

</sub-flow>
	<sub-flow name="smb-ux-business-debit-sub-flow" doc:id="fbad8ca0-b73f-4924-89c0-d08dd81d434a" >
		<logger level="INFO" doc:name="Logger" doc:id="ac85b34e-850e-4b81-a896-3f089479cb17" />
		<scatter-gather doc:name="Copy_of_Scatter-Gather" doc:id="b7ba2d31-bb36-4442-a4b6-747d192f3e05" timeout="60000" maxConcurrency="1" target="UpsertPl">
			<route>
				<ee:transform doc:name="map of Application_c" doc:id="331107ff-a69a-4dac-bb66-cb6a638eb0ee">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="outPayload"><![CDATA[%dw 2.0
output application/json
fun decisionProcess ()=
if (payload.decisions.code[0] == (lower("Passed"))) 
 "In Progress"
 else "Rejected"
 
fun decisionStage ()=
if (payload.decisions.code[0] == (lower("Passed"))) 
 "Pending Deposit Onboarding"
 else "Rejected"
---
[{
  objectName: "Application__c",
  Id: vars.ApplicantInfo.applicationId,
  Application_Status__c: decisionProcess(),
  Application_Stage__c: decisionStage(),
  VSP_Business__c:"",
  Decision_Code_Business__c:payload.decisions.code[0],
  Decision_Description_Business__c: payload.decisions.description[0],
  //Factors_Business__c:"",
  //File_Establish_Date_Business__c:"",
  Profile_Date_Business__c: payload.vendors.primCamsScore.profileDate,
  Profile_Time_Business__c: payload.vendors.primCamsScore.profileTime,
  Risk_Class_Business__c:payload.vendors.primCamsScore.riskClass,
  Score_Business__c: payload.score as String,
  VSP_URL_Business__c:payload.vendors.primCamsScore.vspUrl,
  VSP_Model_Business__c:payload.model,
  VSP_Status_Business__c: if(payload.decisions.code[0]=="passed") "Accepted" else "Rejected"
 }]
 
]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Copy_of_Logger" doc:id="e721d7b8-5946-4e49-b1d1-2a1fc8d775d6" message="#[payload]" />
				<flow-ref doc:name="smb-ux-salesforce-objects-upsert-sub-flow" doc:id="7f2447d8-28e3-4e61-922e-e1b246d6a9e5" name="smb-ux-salesforce-objects-upsert-sub-flow" />
			</route>
			<route>
				<ee:transform doc:name="map of Application_Product_c" doc:id="64333c00-6a84-4c89-8064-e5d755be9b07">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="outPayload"><![CDATA[%dw 2.0
output application/json
fun decisionProcess ()=
if (payload.decisions.code[0] == (lower("Passed"))) 
 "In Progress"
 else "Rejected"

---
[{
   objectName:"Application_Product__c",
   Application__c:vars.ApplicantInfo.applicationId,
   Application_Product_Status__c: decisionProcess()
   //additional field 
 }]]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Copy_of_Logger" doc:id="4bb75f57-d511-4866-8391-2564c8c28a1e" message="#[payload]" />
				<flow-ref doc:name="smb-ux-salesforce-objects-upsert-sub-flow" doc:id="2f208bb7-a0d8-4ec7-b4fd-b5b784d0eca8" name="smb-ux-salesforce-objects-upsert-sub-flow" />
			</route>
			<route>
				<ee:transform doc:name="map of Procust_Role_c" doc:id="768d84d8-64d9-496c-82bc-ccfbdf6bc419">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="outPayload"><![CDATA[%dw 2.0
output application/json
fun decisionProcess ()=
if (payload.decisions.code[0] == (lower("Passed"))) 
 "In Progress"
 else "Rejected"

---
[{
  objectName:"Product_Role__c",
  Relationship__c: vars.sfAppPayload.Business_Relationship__c,
  //Factors__c: "",
  Application_Product__c: "",
  Decision_Code__c: payload.decisions.code[0],
  Decision_Description__c: payload.decisions.description[0],
  //File_Establish_Date__c: "",
  Profile_Date__c: payload.vendors.primCamsScore.profileDate,
  Profile_Time__c: payload.vendors.primCamsScore.profileTime,
  Score__c: payload.score,
  VSP_ID__c: payload.vendors.primCamsScore.vspId,
  VSP_Model__c:payload.model,
  VSP_URL__c: payload.vendors.primCamsScore.vspUrl,
  Product_Role_Status__c: decisionProcess(),
  VSP_Status__c: if(payload.decisions.code[0]=="passed") "Accepted" else "Rejected"
 }]]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Copy_of_Logger" doc:id="bd364bde-265f-46a3-810f-5481c3da0f84" message="#[payload]" />
				<flow-ref doc:name="smb-ux-salesforce-objects-upsert-sub-flow" doc:id="e621035c-9177-4547-9074-3971a0d9c3c4" name="smb-ux-salesforce-objects-upsert-sub-flow" />
			</route>
			<route >
				<ee:transform doc:name="map of VSP__C" doc:id="d9be40f4-f5ec-4358-9e96-5719a5e5e387" >
					<ee:message >
					</ee:message>
					<ee:variables >
						<ee:set-variable variableName="outPayload" ><![CDATA[%dw 2.0
output application/json
---
[{
   "objectName":"VSP_Intergation__c",	
   //"action__c":"",?
   //"CreatedById":"",
   //"CreatedDate":"",
   "Decision_Code__c":payload.decisions.code[0],
   "Decision_Description__c":payload.decisions.description[0],
   //"factors__c":"",
   //"file__c":"",
   //"IsDeleted":"",
   //"LastActivityDate":"",
   //"LastModifiedById":"",
   //"LastModifiedDate":"",
   //"LastReferencedDate":"",
   //"LastViewedDate":"",
   //"Name":"",
   "OwnerId": p ('Sf.vsp_owner'),
   //"profileData__c":"",
   "profileDate__c":payload.vendors.primCamsScore.profileDate,
   "profileTime__c":payload.vendors.primCamsScore.profileTime,
   "Relationship__c":vars.sfAppPayload.Business_Relationship__c,
   "riskClass__c":payload.vendors.primCamsScore.riskClass,
   "score__c":payload.score,
   //"SystemModstamp":"",
   "VSP_ID__c": payload.vendors.primCamsScore.vspId,
   "VSP_Model__c":payload.model,
   //"VSP_Results__c":if(payload.decisions.code[0]=="passed") "Accepted" else "Rejected",
   "VSP_URL__c": payload.vendors.primCamsScore.vspUrl
}]]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Logger" doc:id="46f21884-a75a-4ac7-b343-5ca33b711324" message="#[payload]"/>
				<flow-ref doc:name="smb-ux-salesforce-objects-create-subflow" doc:id="1a42a3e5-4add-4638-971c-0eeb42ace7d2" name="smb-ux-salesforce-objects-create-subflow"/>
			</route>
		</scatter-gather>
	</sub-flow>
	



</mule>
