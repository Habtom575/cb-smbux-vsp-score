<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns:tls="http://www.mulesoft.org/schema/mule/tls" xmlns:api-gateway="http://www.mulesoft.org/schema/mule/api-gateway"
	xmlns:secure-properties="http://www.mulesoft.org/schema/mule/secure-properties"
	xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/secure-properties http://www.mulesoft.org/schema/mule/secure-properties/current/mule-secure-properties.xsd
http://www.mulesoft.org/schema/mule/api-gateway http://www.mulesoft.org/schema/mule/api-gateway/current/mule-api-gateway.xsd
http://www.mulesoft.org/schema/mule/tls http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd">
	<sub-flow name="smb-ux-busines-deposit-flow" doc:id="ff5eaa5e-9793-4e00-bd08-25889109cf70" >
		<logger level="INFO" doc:name="Logger" doc:id="27062994-1299-4fb7-a5be-ec297e191c04" />
		<flow-ref doc:name="smb-ux-salesforce-objects-query-subflow" doc:id="4094aea6-e1c5-4adf-bd8d-08e60b366fe3" name="smb-ux-salesforce-objects-query-subflow"/>
		<ee:transform doc:name="Transform Message" doc:id="7f0a8dbb-9eb2-4c3e-bc52-53cb3946ecfb" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="VSPAplicant" ><![CDATA[%dw 2.0
output application/json
import * from dw::core::Strings

var modelCode =
  if (vars.ApplicantInfo.customerType=="2" and vars.ApplicantInfo.product=="T")  
    "TreasuryCams" 
  else if (vars.ApplicantInfo.customerType=="2" and vars.ApplicantInfo.product=="D") 
    "smbBusiness"
  else if (vars.ApplicantInfo.customerType=="2" and vars.ApplicantInfo.product=="L" ) 
     "smbCredit1"
  else 
    "smbSigner"

---
{
	"RequestDate": now(),
    "RequestID":vars.ApplicantInfo.applicationId,
    "PersonID": vars.sfAppPayload.Name_of_Business__c[0],
    "IP": vars.sfAppPayload.applicant_ip[0] default "",
    "useBlacklist": false,
    "Model": modelCode,
    "ClientID": "1",
    "Company": {
      "CompanyName": vars.sfAppPayload.Name_of_Business__c[0],
      "AlternateCompanyName": vars.sfAppPayload.Altrnate_Business_Name__c[0],
      "FEIN": vars.sfAppPayload.EIN__c[0],
      "Phone": vars.sfAppPayload.Business_Phone__c[0],
      "StreetAddress1": vars.sfAppPayload.Business_Address_1__c[0],
      "StreetAddress2": vars.sfAppPayload.Business_Address_2__c[0],
      "City": vars.sfAppPayload.Business_City__c[0],
      "State": vars.sfAppPayload.Business_State__c[0],
      "Zip": vars.sfAppPayload.Business_Zip__c[0],
  
      "ApplicantSigners": [
        {
         "FirstName": vars.sfAppPayload.First_Name__c[0],
        "LastName": vars.sfAppPayload.Last_Name__c[0],
        "StreetAddress1": vars.sfAppPayload.Address_1__c[0],
        "StreetAddress2": vars.sfAppPayload.Address_2__c[0],
        "City": vars.sfAppPayload.City__c[0],
        "State": vars.sfAppPayload.State__c[0],
        "Zip": vars.sfAppPayload.Zip__c[0],
        "Phone": vars.sfAppPayload.Phone__c[0],
        "Email": vars.sfAppPayload.Email__c[0],
        "SSN": vars.sfAppPayload.Social_Security_Number__c[0],
        "DOB": vars.sfAppPayload.Birth_Date__c[0],
        "IDType":  if(vars.sfAppPayload.ID_Type__c[0]== "Driver's License") 1 else 9,
        "IDState": vars.sfAppPayload.ID_State__c[0],
        "IDCountry": vars.sfAppPayload.ID_Country__c[0] default "",
        "IDNumber": vars.sfAppPayload.ID_Number__c[0]
        }
      ]
    }
  }
]]></ee:set-variable>
			</ee:variables>
		
</ee:transform>
		<flow-ref doc:name="SMB-UX-VSP-loginFlow" doc:id="1858091e-46f7-4656-9e5f-fa7679ce77c1" name="SMB-UX-VSP-loginFlow" target="Authorization"/>
		<set-variable value="#[vars.Authorization]" doc:name="Copy_of_Set Variable" doc:id="c4047cc0-2a3d-4296-a09c-6868bb698538" variableName="BearerToken" />
		<http:request method="POST" doc:name="Request" doc:id="c8f6b22d-e273-41e3-88b3-cf8fc026e29b" path="/score" config-ref="HTTP_Request_VSP_configuration" target="VSPBusinessScore">
			<http:body ><![CDATA[#[vars.VSPAplicant]]]></http:body>
			<http:headers ><![CDATA[#[{
	"Authorization" : "Bearer " ++ vars.BearerToken
}]]]></http:headers>
		</http:request>
		<ee:transform doc:name="Copy_of_Transform Message" doc:id="923d2abf-b1e3-4e70-bde3-39be34280586">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="RejectedDecisions" ><![CDATA[%dw 2.0
output application/json
---
if(vars.VSPBusinessScore.decisions.code[0]=="rejected")true else false]]></ee:set-variable>
			
</ee:variables>
		</ee:transform>
		<choice doc:name="Choice" doc:id="13542e21-8c2d-4dab-95c9-88976ed8197e" >
			<when expression="#[vars.RejectedDecisions == true]">
				<logger level="INFO" doc:name="Logger" doc:id="57f08c49-4024-4779-b9b9-51de7637fec5" />
				<flow-ref doc:name="smb-ux-business-deposit-sub-flow" doc:id="50a13a31-0ddd-4deb-bf76-8ed59cd97d75" name="smb-ux-business-deposit-sub-flow"/>
			
</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="a8e8eeb9-0e6b-45e0-a5fd-e28ddb2b49d7" />
				<flow-ref doc:name="smb-ux-business-deposit-sub-flow" doc:id="cd223a22-411d-4d15-8b3a-6429f7c5a01f" name="smb-ux-business-deposit-sub-flow"/>
				<flow-ref doc:name="smb-ux-additional-appliacant-flow" doc:id="99683e20-eda9-404a-ad50-b71d2c75ce1d" name="smb-ux-additional-appliacant-flow" target="upsertAdditAppData"/>
			

</otherwise>
		</choice>
		<ee:transform doc:name="Transform Message" doc:id="3548c5c6-f291-47d4-b9ae-686bcf794cd0" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
 {"score_result": { 
 "applicationId": if(payload.items.payload.id[0]== true) payload.items.payload.id[0] else vars.ApplicantInfo.applicationId, 
 "customerType": vars.ApplicantInfo.customerType,
 "product": vars.ApplicantInfo.product,
 "VSPStatus":if(vars.VSPBusinessScore.decisions.code[0]=="passed") "Accepted" else "Rejected"
 },
 "metadata":{
 	status: 200,
 	message: "Success" 
 }
 
 }]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	

</sub-flow>
	<sub-flow name="smb-ux-business-deposit-sub-flow" doc:id="fbad8ca0-b73f-4924-89c0-d08dd81d434a" >
		<logger level="INFO" doc:name="Logger" doc:id="ac85b34e-850e-4b81-a896-3f089479cb17" />
		<scatter-gather doc:name="Copy_of_Scatter-Gather" doc:id="b7ba2d31-bb36-4442-a4b6-747d192f3e05" timeout="60000" maxConcurrency="1">
			<route>
				<ee:transform doc:name="map of Application_c" doc:id="331107ff-a69a-4dac-bb66-cb6a638eb0ee">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="outPayload"><![CDATA[%dw 2.0
output application/json
var busDeposit= if(vars.VSPBusinessScore.decisions.code[0]=="passed") "Accepted"
 else if (vars.VSPBusinessScore.decisions.code[0]=="Document Required") "Document Required" else "Rejected"
var busLoan= if(vars.VSPBusinessScore.decisions.code[0]=="passed") "Accepted" 
 else "Rejected"
var vspModel= if(vars.ApplicantInfo.product=="D" and vars.ApplicantInfo.customerType=="2") vars.VSPBusinessScore.model
               else "smbCredit1" 

fun decisionProcess ()=
if (vars.VSPBusinessScore.decisions.code[0] == (lower("Passed"))) 
 "In Progress"
 else "Rejected"
 
fun decisionStage ()=
if (vars.VSPBusinessScore.decisions.code[0] == (lower("Passed"))) 
 "Pending Deposit Onboarding"
 else "Rejected"
---
[{
  objectName: "Application__c",
  Id: vars.ApplicantInfo.applicationId,
  Application_Status__c: decisionProcess(),
  Application_Stage__c: decisionStage(),
  VSP_Business__c:"",
  Decision_Code_Business__c:vars.VSPBusinessScore.decisions.code[0],
  Decision_Description_Business__c: vars.VSPBusinessScore.decisions.description[0],
  //Factors_Business__c:"",
  //File_Establish_Date_Business__c:"",
  Profile_Date_Business__c: vars.VSPBusinessScore.vendors.primCamsScore.profileDate,
  Profile_Time_Business__c: vars.VSPBusinessScore.vendors.primCamsScore.profileTime,
  Risk_Class_Business__c:vars.VSPBusinessScore.vendors.primCamsScore.riskClass,
  Score_Business__c: vars.VSPBusinessScore.score as String,
  VSP_URL_Business__c:vars.VSPBusinessScorevendors.primCamsScore.vspUrl,
  VSP_Model_Business__c:vspModel,
  VSP_Status_Business__c: if(vars.ApplicantInfo.product=="D" and vars.ApplicantInfo.customerType=="2") busDeposit
               else busLoan 
 }]
 
]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Copy_of_Logger" doc:id="e721d7b8-5946-4e49-b1d1-2a1fc8d775d6" message="#[payload]" />
				<flow-ref doc:name="smb-ux-salesforce-objects-upsert-sub-flow" doc:id="7f2447d8-28e3-4e61-922e-e1b246d6a9e5" name="smb-ux-salesforce-objects-upsert-sub-flow" />
			</route>
			<route>
				<salesforce:query doc:name="Query" doc:id="29a407f8-18f0-422b-b1d0-29046d633e4c" config-ref="Salesforce_Config" readTimeoutUnit="MILLISECONDS">
					<salesforce:salesforce-query><![CDATA[select fields(All) from  Application_Product__c 
where Application__c= ':applicationId' and
    Product_Family__c= ':Product_Family__c' limit 200]]></salesforce:salesforce-query>
					<salesforce:parameters><![CDATA[#[{
	applicationId: vars.ApplicantInfo.applicationId,
	Product_Family__c: if( vars.ApplicantInfo.product== "D") "Deposit" else if (vars.ApplicantInfo.product== "L") "Loan" else "Treasury"
  
	
}]]]></salesforce:parameters>
				</salesforce:query>
				<set-variable value="#[payload]" doc:name="Set Variable" doc:id="4dcff1e4-c10e-4e83-86a8-33839102333e" variableName="SfApplicationProd" />
				<ee:transform doc:name="map of Application_Product_c" doc:id="64333c00-6a84-4c89-8064-e5d755be9b07">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="outPayload"><![CDATA[%dw 2.0
output application/json
fun decisionProcess ()=
if (vars.VSPBusinessScore.decisions.code[0] == (lower("Passed"))) 
 "In Progress"
 else "Rejected"

---
 vars.SfApplicationProd map ((item, indeex) -> {
   objectName:"Application_Product__c",
   //Application__c:vars.ApplicantInfo.applicationId,
   Application_Product_Status__c: decisionProcess(),
   Id: item.Id  })]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Copy_of_Logger" doc:id="4bb75f57-d511-4866-8391-2564c8c28a1e" message="#[payload]" />
				<flow-ref doc:name="smb-ux-salesforce-objects-upsert-sub-flow" doc:id="2f208bb7-a0d8-4ec7-b4fd-b5b784d0eca8" name="smb-ux-salesforce-objects-upsert-sub-flow" />
				<foreach doc:name="For Each" doc:id="7d0ce19f-b07d-46d1-840c-c09217b3fde8" collection="#[vars.SfApplicationProd]">
					<set-variable value="#[payload]" doc:name="Set Variable" doc:id="f370155b-1c77-4e1f-a4e0-1abc7fa05905" variableName="currentApplicationPro"/>
					<salesforce:query doc:name="Copy_of_Query" doc:id="5f0392e5-70e2-4c15-9af5-5d1e191e4fa2" config-ref="Salesforce_Config" readTimeoutUnit="MILLISECONDS" target="currentProductRole">
					<salesforce:salesforce-query><![CDATA[select fields(All) from  Product_Role__c 
where Application_Product__c= ':applicationPro' and
    Relationship__c= ':Relationship' limit 200]]></salesforce:salesforce-query>
					<salesforce:parameters><![CDATA[#[{
	applicationPro: vars.currentApplicationPro.Id,
	Relationship: vars.sfAppPayload.Business_Relationship__c[0]
	
}]]]></salesforce:parameters>
				</salesforce:query>
					<ee:transform doc:name="map of Procust_Role_c" doc:id="768d84d8-64d9-496c-82bc-ccfbdf6bc419">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="outPayload"><![CDATA[%dw 2.0
output application/json
var busDeposit= if(vars.VSPBusinessScore.decisions.code[0]=="passed") "Accepted"
 else if (vars.VSPBusinessScore.decisions.code[0]=="Document Required") "Document Required" else "Rejected"
var busLoan= if(vars.VSPBusinessScore.decisions.code[0]=="passed") "Accepted" 
 else "Rejected"
var vspModel= if(vars.ApplicantInfo.product=="D" and vars.ApplicantInfo.customerType=="2") vars.VSPBusinessScore.model
               else "smbCredit1" 

fun decisionProcess ()=
if (vars.VSPBusinessScore.decisions.code[0] == (lower("Passed"))) 
 "In Progress"
 else "Rejected"

---
 [{
  objectName:"Product_Role__c",
  Relationship__c: vars.sfAppPayload.Business_Relationship__c[0],
  //Factors__c: "",
  Application_Product__c: vars.SfApplicationProd.Id[0],
  Id:vars.currentProductRole.Id[0],
  Decision_Code__c: vars.VSPBusinessScore.decisions.code[0],
  Decision_Description__c: vars.VSPBusinessScore.decisions.description[0],
  //File_Establish_Date__c: "",
  Profile_Date__c: vars.VSPBusinessScore.vendors.primCamsScore.profileDate,
  Profile_Time__c: vars.VSPBusinessScore.vendors.primCamsScore.profileTime,
  Score__c: vars.VSPBusinessScore.score as String,
  VSP_ID__c: vars.VSPBusinessScore.vendors.primCamsScore.vspId,
  VSP_Model__c:vspModel,
  VSP_URL__c: vars.VSPBusinessScore.vendors.primCamsScore.vspUrl,
  Product_Role_Status__c: decisionProcess(),
  VSP_Status__c: if(vars.ApplicantInfo.product=="D" and vars.ApplicantInfo.customerType=="2") busDeposit
               else busLoan 
 }]]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
					<logger level="INFO" doc:name="Copy_of_Logger" doc:id="bd364bde-265f-46a3-810f-5481c3da0f84" message="#[payload]" />
					<flow-ref doc:name="smb-ux-salesforce-objects-upsert-sub-flow" doc:id="e621035c-9177-4547-9074-3971a0d9c3c4" name="smb-ux-salesforce-objects-upsert-sub-flow" />
				</foreach>
			</route>
			<route>
				<ee:transform doc:name="map of VSP__C" doc:id="d9be40f4-f5ec-4358-9e96-5719a5e5e387">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="outPayload"><![CDATA[%dw 2.0
output application/json
var vspModel= if(vars.ApplicantInfo.product=="D" and vars.ApplicantInfo.customerType=="2") vars.VSPBusinessScore.model
               else "smbCredit1" 
---
[{
   "objectName":"VSP_Intergation__c",	
   //"action__c":"",?
   "Decision_Code__c": vars.VSPBusinessScore.decisions.code[0],
   "Decision_Description__c":vars.VSPBusinessScore.decisions.description[0],
   //"factors__c":"",
   //"file__c":"",
   "OwnerId": p ('Sf.vsp_owner'),
   "profileDate__c":vars.VSPBusinessScore.vendors.primCamsScore.profileDate,
   "profileTime__c":vars.VSPBusinessScore.vendors.primCamsScore.profileTime,
   "Relationship__c":vars.sfAppPayload.Business_Relationship__c[0],
   "riskClass__c":vars.VSPBusinessScore.vendors.primCamsScore.riskClass,
   "score__c":vars.VSPBusinessScore.score as String,
   //"SystemModstamp":"",
   "VSP_ID__c": vars.VSPBusinessScore.vendors.primCamsScore.vspId,
   "VSP_Model__c": vspModel,
   //"VSP_Results__c":if(payload.decisions.code[0]=="passed") "Accepted" else "Rejected",
   "VSP_URL__c": vars.VSPBusinessScore.vendors.primCamsScore.vspUrl
}]]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Logger" doc:id="46f21884-a75a-4ac7-b343-5ca33b711324" message="#[payload]" />
				<flow-ref doc:name="smb-ux-salesforce-objects-create-subflow" doc:id="1a42a3e5-4add-4638-971c-0eeb42ace7d2" name="smb-ux-salesforce-objects-create-subflow" />
			</route>
		</scatter-gather>
	</sub-flow>
	



</mule>
